# Plan for Python3 Modernization and Codebase Cleanup (2025-05-19)

This document outlines the initial plan to modernize the `hap.py` codebase to Python 3 best practices,
enhance packaging, and clean up legacy artifacts. We will iteratively work through defined tasks,
document progress, and update the README with dated changelogs.

## Task 1: Identify and Archive Legacy Artifacts
- Review and archive legacy Python2 migration and AI-assistant artifacts:
  - `.claude/` directory, legacy lint configs (`.pylintrc`), editor settings (`.ycm_extra_conf.py`), and standalone docs (`format.md`).
  - Installer scripts and leftover requirements: `install.py`, `happy.core-requirements.py3.txt`,
    any files or scripts with `.py3` suffix or `py2to3_migrate.sh` patterns.
  - Deprecated Dockerfiles: `Dockerfile.ubuntu-with-tests`, `Dockerfile.centos6`.
- Review and archive build-generated artifacts:
  - CMake cache and build folders: `CMakeCache.txt`, `CMakeFiles/`.
- Identify and archive any additional deprecated or unused files and move all to `.github/archive/`.

> **Progress (2025-05-19)**: Completed Task 1: archived legacy Python2 migration artifacts and build-generated files to `.github/archive/`.

## Task 2: Establish Development Tooling
- Add `requirements-dev.txt` with pre-commit hooks and development dependencies:
  - pre-commit, black, isort, ruff, pyupgrade, mypy types.
- Ensure `.pre-commit-config.yaml` is present and up-to-date.
- Add Nox or tox configuration for reproducible test environments (optional)

> **Progress (2025-05-20)**: Completed Task 2: finalized requirements-dev.txt and `.pre-commit-config.yaml`, and added `noxfile.py` for reproducible development sessions.

## Task 3: Enforce Code Style and Static Analysis
- Run `pre-commit run --all-files` and fix issues:
  - Apply Black formatting.
  - Organize imports with isort.
  - Lint and auto-fix with ruff.
  - Upgrade syntax with pyupgrade (`--py37-plus`).
  - Validate types with mypy (`--ignore-missing-imports`).
  - Ensure `pyproject.toml` includes a `[build-system]` section with numpy and Cython build requirements for isolated builds.
  - Update `get_include_dirs` in `setup.py` to include the `helpers` subdirectory for C++ headers (Roc.hh).
  - Fix Cython extern declarations and header paths for ROC (namespace "roc") and variant modules (namespace "variant").

> **Progress (2025-05-22)**: Added `[build-system]` section to `pyproject.toml` with numpy and Cython build requirements to enable isolated build environments to install dependencies before building extensions.
> **Progress (2025-05-23)**: Added missing `from libcpp.vector cimport vector` import to `src/python/Haplo/happyroc.pyx` to fix Cython build errors in isolated build environments.
> **Progress (2025-05-24)**: Updated `get_include_dirs` in `setup.py` to include the `helpers` subdirectory so that `Roc.hh` is found during Cython extension builds in isolated environments.
> **Progress (2025-05-25)**: Fixed Cython extern declarations in `src/python/Haplo/happyroc.pyx` and `src/python/Haplo/variant_processor.pyx` to use correct namespaces ("roc", "variant") and updated header paths.

## Task 4: Modernize Packaging
- Update `setup.py` and `setup.cfg` for Python 3 only:
  - Set `python_requires='>=3.7'`.
  - Migrate metadata to `setup.cfg` (if appropriate).
  - Ensure entry points are defined.
- Add `pyproject.toml` with build-system requirements.

## Task 5: Modularize and Refactor
- Break large modules into smaller, well-defined packages.
- Introduce type hints incrementally on critical modules.
- Replace legacy argument parsing (`optparse`) with `argparse` or `click`.

## Task 6: Documentation and Changelog
-- Update `README.md` with modernization progress logs.
-- Create `RELEASES.md` entries for each milestone.

## Task 7: Migrate CLI into `happy` Package
- Move and refactor CLI scripts (`hap.py`, `qfy.py`, `pre.py`, `ftx.py`, `cnx.py`, `ovc.py`) into `src/python/happy`.
- Clean up imports—use `happy.Haplo` and `happy.Tools` modules exclusively.
- Remove legacy `sys.path` hacks.
- Add smoke tests under `tests/` to validate `python -m happy.<cmd> --help` output.

## Task 8: CLI Linting and Type Enforcement
- Remove `# mypy: skip-file` from CLI modules and add stable type hints.
- Lift Ruff ignores on CLI scripts—enforce import placement, line lengths, variable names.
- Add pytest/unit tests for basic workflows (run commands on small example data).

---
_This plan will be updated as tasks progress or new issues are discovered._
